#!/usr/bin/env ruby
require 'pathname'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

def start_db env
  system "docker start pokesite-#{env}-db && sleep 5"
end

def start env
  start_db env
  system "docker start -a pokesite-#{env}"
end

def stop_db env
  system "docker stop pokesite-#{env}-db"
end

def run env, cmd, args = []
  start_db env
  system "docker run -i -t --link pokesite-#{env}-db:db --volumes-from pokesite-dev --rm pokesite #{cmd} #{args.join " "}"
end

Dir.chdir APP_ROOT do
  cmd = ARGV.shift

  case cmd
  when "start"
    start_db "dev"
    system "docker start -a pokesite-dev"
  when "stop"
    system "docker stop pokesite-dev"
    stop_db "dev"
  when "spec"
    run "test", "bin/rspec", ARGV
    stop_db "test"
  when "run"
    cmd = ARGV.shift
    run "dev", cmd, ARGV
  else
    puts "Usage: bin/d {start|stop|spec [ARGUMENTS]|run COMMAND [ARGUMENTS]}"
  end
end
